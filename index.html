<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nexodify’s Label Compliance Preflight — Client Intake</title>
  <style>
    :root{
      --bg:#0c1022;--bg2:#0f1430;--panel:#111736;--panel-2:#0b122c;
      --ink:#eaf0ff;--muted:#9fb0d6;--line:#1d2a57;--accent:#4f7dff;--accent-2:#2a3975;
      --ok:#10b981;--warn:#f59e0b;--fail:#ef4444;--chip:#22306b;
      --shadow:0 10px 24px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink); background:
        radial-gradient(1200px 1200px at -10% -10%, #1b2559 0%, transparent 55%),
        radial-gradient(1000px 1000px at 110% -10%, #17204e 0%, transparent 50%),
        var(--bg);
    }
    .container{max-width:1100px;margin:32px auto;padding:0 20px 140px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:10px}
    .brandLogo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,#6aa3ff,#4f7dff 60%,#3b5cff);box-shadow:var(--shadow)}
    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .sub{margin:6px 0 0;color:var(--muted)}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .full{grid-column:1 / -1}
    @media (max-width:860px){.grid.two{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.2px;color:#cfe1ff}

    label{font-weight:600;font-size:13px;margin-bottom:6px;display:block;color:#cfe1ff}
    input,textarea,select{width:100%;background:var(--panel-2);color:var(--ink);border:1px solid var(--accent-2);border-radius:12px;padding:10px 12px;outline:none}
    textarea{min-height:110px;resize:vertical}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .drop{display:flex;align-items:center;justify-content:center;gap:10px;border:1.5px dashed #3550a3;border-radius:12px;padding:16px;background:var(--panel-2);transition:.15s ease;cursor:pointer;text-align:center}
    .drop:hover{border-color:#5f88ff}
    .drop.drag{background:#101a45;border-color:#7aa3ff}
    .fileMeta{margin-top:8px;color:#cbd8ff;font-size:12px}

    .switch{position:relative;width:48px;height:28px;flex:0 0 auto}
    .switch input{display:none}
    .switch .slider{position:absolute;inset:0;border-radius:999px;background:#3b456e;transition:.18s;box-shadow:inset 0 0 0 1px var(--accent-2)}
    .switch .slider:before{content:"";position:absolute;left:3px;top:3px;width:22px;height:22px;background:#fff;border-radius:50%;transition:.18s}
    .switch input:checked+.slider{background:var(--ok);box-shadow:inset 0 0 0 1px #0e8e6c}
    .switch input:checked+.slider:before{transform:translateX(20px)}

    .actions{display:flex;gap:12px;justify-content:flex-end}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1a275c}
    .btn[disabled]{opacity:.7;cursor:not-allowed}
    .spinner{width:16px;height:16px;border-radius:50%;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;display:inline-block;margin-right:8px;animation:spin .8s linear infinite;vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}

    .chip{display:inline-block;background:#22306b;border:1px solid #354684;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;margin-right:8px}
    .pass{background:#10b981;color:#052}.caution{background:#f59e0b;color:#320}.fail{background:#ef4444;color:#300}

    .pre{white-space:pre-wrap;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .kv{min-width:240px}
    .ok{color:#a7f3d0}.issue{color:#fde68a}.missing{color:#fecaca}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="brandLogo" aria-hidden="true"></div>
        <div>
          <h1>Nexodify’s Label Compliance Preflight</h1>
          <div class="sub">Cited. Actionable. Production-ready.</div>
          <div class="sub" style="font-size:12px; opacity:.85">EU 1169/2011 preflight • optional Halal pre-audit • PDF report</div>
        </div>
      </div>
    </header>

    <form id="f" class="grid" onsubmit="return false">
      <div class="grid two">
        <div class="card">
          <h3>Product</h3>
          <label>Product name</label>
          <input name="product_name" placeholder="Pasta di Ceci" required/>
          <div class="grid two" style="margin-top:10px">
            <div><label>Country of sale</label><input name="country_of_sale" placeholder="Italy" required/></div>
            <div><label>Languages on label (ISO, comma)</label><input name="languages_provided" placeholder="it,en"/></div>
          </div>
          <div class="grid two" style="margin-top:10px">
            <div>
              <label>Shipping scope</label>
              <select name="shipping_scope">
                <option value="local">Local / Domestic</option>
                <option value="eu">EU Single Market</option>
                <option value="global">Global</option>
              </select>
            </div>
            <div>
              <label>Category</label>
              <select name="product_category">
                <option value="general">General</option>
                <option value="confectionery">Confectionery</option>
                <option value="beverage">Beverage</option>
                <option value="dairy">Dairy</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Company</h3>
          <label>Company name</label>
          <input name="company_name" placeholder="ACME Foods S.r.l." required/>
          <label style="margin-top:10px">Company email (report will be sent here)</label>
          <input name="company_email" type="text" placeholder="qa@acmefoods.it, qa2@acmefoods.it" required/>
          <div class="hint">You can enter multiple emails separated by comma or semicolon.</div>
        </div>
      </div>

      <div class="grid two">
        <div class="card" id="labelCard">
          <h3>Label file (JPG/PNG or PDF)</h3>
          <div id="labelDrop" class="drop">Drag &amp; drop or click to choose</div>
          <input id="labelInput" name="label_file" type="file" accept="image/*,.pdf" style="display:none" required/>
          <div class="fileMeta" id="labelMeta">No file chosen.</div>
          <div id="labelPreview" class="hint"></div>
          <div class="hint">Front-on, readable images work best. PDF is parsed for text only.</div>
        </div>

        <div class="card">
          <h3>Optional TDS (.pdf, .docx, .md, .txt)</h3>
          <div id="tdsDrop" class="drop">Drag &amp; drop or click to attach</div>
          <input id="tdsInput" name="tds_file" type="file" accept=".pdf,.docx,.md,.txt" style="display:none"/>
          <div class="fileMeta" id="tdsMeta">No file chosen.</div>
        </div>
      </div>

      <div class="card full">
        <h3>Extra rules / buyer requirements (optional)</h3>
        <textarea name="reference_docs_text" placeholder="Paste internal spec, buyer rules, claims substantiation..."></textarea>
        <div class="hint">If omitted, the engine uses EU baseline and our internal database.</div>
      </div>

      <div class="card full">
        <h3>Options</h3>
        <label class="switch" title="Enable Halal pre-audit">
          <input type="checkbox" name="halal_audit"/><span class="slider" aria-hidden="true"></span>
        </label>
        <span class="sub" style="margin-left:12px">Halal pre-audit — checks for forbidden ingredients, carriers/solvents, logo/issuer, segregation.</span>
      </div>

      <div class="actions full">
        <button class="btn secondary" type="button" id="resetBtn">Reset</button>
        <button class="btn" id="generateBtn" type="button">Generate Preflight</button>
      </div>
    </form>

    <div id="out" class="grid" style="margin-top:18px"></div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const out = $('#out'), btn = $('#generateBtn'), resetBtn = $('#resetBtn');
    const labelDrop = $('#labelDrop'), labelInput = $('#labelInput'), labelMeta = $('#labelMeta'), labelPreview = $('#labelPreview');
    const tdsDrop = $('#tdsDrop'), tdsInput = $('#tdsInput'), tdsMeta = $('#tdsMeta');
    const form = document.getElementById('f');

    function setLoading(state){
      if(state){ btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>Generating…'; }
      else { btn.disabled = false; btn.textContent = 'Generate Preflight'; }
    }
    function bindDrop(dropEl, inputEl, metaEl, previewEl){
      dropEl.addEventListener('click', ()=>inputEl.click());
      ['dragenter','dragover'].forEach(ev=>dropEl.addEventListener(ev, e=>{e.preventDefault(); dropEl.classList.add('drag');}));
      ['dragleave','drop'].forEach(ev=>dropEl.addEventListener(ev, e=>{e.preventDefault(); dropEl.classList.remove('drag');}));
      dropEl.addEventListener('drop', e=>{
        const f = e.dataTransfer.files && e.dataTransfer.files[0];
        if(!f) return;
        inputEl.files = e.dataTransfer.files;
        metaEl.textContent = f.name + ' (' + Math.round(f.size/1024) + ' KB)';
        if(previewEl) previewFile(f, previewEl);
      });
      inputEl.addEventListener('change', ()=>{
        const f = inputEl.files && inputEl.files[0];
        if(!f){ metaEl.textContent = 'No file chosen.'; if(previewEl) previewEl.innerHTML=''; return; }
        metaEl.textContent = f.name + ' (' + Math.round(f.size/1024) + ' KB)';
        if(previewEl) previewFile(f, previewEl);
      });
    }
    function previewFile(file, el){
      if (file.type.startsWith('image/')){
        const r = new FileReader();
        r.onload = () => { el.innerHTML = '<div class="hint">Preview:</div><img src="'+r.result+'" style="max-width:220px;border-radius:10px;margin-top:6px;border:1px solid #2a3975"/>'; };
        r.readAsDataURL(file);
      } else {
        el.innerHTML = '<span class="hint">Preview: PDF/Doc selected</span>';
      }
    }
    bindDrop(labelDrop, labelInput, labelMeta, labelPreview);
    bindDrop(tdsDrop, tdsInput, tdsMeta, null);

    async function fileToDataUrlImage(file){
      const fr = new FileReader();
      const dataUrl = await new Promise((res,rej)=>{ fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
      const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
      const maxDim=1600; let {width,height}=img;
      if(width>maxDim||height>maxDim){ const s=Math.min(maxDim/width,maxDim/height); width=Math.round(width*s); height=Math.round(height*s);}
      const c=document.createElement('canvas'); c.width=width; c.height=height;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,width,height);
      return c.toDataURL('image/jpeg',0.85);
    }
    async function fileToBase64(file){
      return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
    }
    function esc(s){ return (s==null?"":String(s)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }

    function renderChecks(title, checks){
      let html = `<div class="card full"><h3>${title}</h3>`;
      if(!checks || !checks.length){ html += `<div class="hint">No items.</div>`; }
      for(const c of (checks||[])){
        const icon = c.status === 'ok' ? '✅' : (c.status === 'missing' ? '⛔' : '⚠️');
        html += `<div style="margin:10px 0">
          <div><b>${icon} ${esc(c.title)}</b>
            <span class="chip">${esc(c.status.toUpperCase())}</span>
            <span class="chip">${esc(c.severity)}</span>
          </div>`;
        if(c.detail) html += `<div class="pre" style="color:#cbd8ff;margin-top:4px">• ${esc(c.detail)}</div>`;
        if(c.status !== 'ok'){
          if(c.fix) html += `<div class="pre" style="color:#a6f5c9;margin-top:4px">→ Fix: ${esc(c.fix)}</div>`;
          if(Array.isArray(c.sources) && c.sources.length){
            html += `<div class="pre" style="color:#bdc8ff;margin-top:2px">Sources: ${esc(c.sources.join('; '))}</div>`;
          }
        }
        html += `</div>`;
      }
      html += `</div>`;
      return html;
    }

    async function handleGenerate(){
      setLoading(true);
      out.innerHTML = '';

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.languages_provided = (payload.languages_provided||'').split(',').map(s=>s.trim()).filter(Boolean);
      payload.halal_audit = !!fd.get('halal_audit');

      const labelFile = labelInput.files[0];
      if(!labelFile){ alert('Please choose a label file.'); setLoading(false); return; }
      if(labelFile.type === 'application/pdf' || /\.pdf$/i.test(labelFile.name)){
        payload.label_pdf_file = { name: labelFile.name, base64: await fileToBase64(labelFile) };
      } else {
        payload.label_image_data_url = await fileToDataUrlImage(labelFile);
      }

      const tds = tdsInput.files[0];
      if(tds){ payload.tds_file = { name: tds.name, base64: await fileToBase64(tds) }; }

      try{
        const res = await fetch('/api/labelcheck', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const raw = await res.text(); let data;
        try{ data = JSON.parse(raw); } catch{ out.innerHTML = '<div class="card">Server error:<br><pre class="pre">'+esc(raw)+'</pre></div>'; setLoading(false); return; }
        if(data.error) throw new Error(data.error);

        const status = data.report?.overall_status || 'caution';
        const score  = data.score ?? '-';
        const prod   = data.report?.product || {};
        let html = `<div class="card full">
          <div class="badge ${status}">${status.toUpperCase()}</div>
          <span class="chip">Score ${score}/100</span>
          <span class="chip">Halal: ${data.halal_audit?'ON':'OFF'}</span>
          ${data.email_status ? `<span class="chip">Email: ${esc(data.email_status)}</span>` : ''}
          <div class="row" style="margin-top:10px">
            <div class="kv"><b>Name:</b> ${esc(prod.name)||'-'}</div>
            <div class="kv"><b>Country:</b> ${esc(prod.country_of_sale)||'-'}</div>
            <div class="kv"><b>Languages:</b> ${(prod.languages_provided||[]).join(', ')||'-'}</div>
          </div>
          ${data.report?.summary ? `<div class="pre" style="margin-top:8px">${esc(data.report.summary)}</div>` : ''}
        </div>`;

        html += renderChecks('EU 1169/2011 Checks', data.report?.checks);
        if(Array.isArray(data.halal_checks) && data.halal_checks.length){
          html += renderChecks('Halal Pre-Audit', data.halal_checks);
        }

        /* ---- Correct PDF download block (must be added to html string) ---- */
        html += `<div class="card full" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div class="sub">Downloads</div>
          <div>
            ${data.pdf_base64
              ? `<a download="Preflight_Report.pdf" href="data:application/pdf;base64,${data.pdf_base64}">
                   <button class="btn" type="button">Download Report (PDF)</button>
                 </a>`
              : ``}
          </div>
        </div>`;

        out.innerHTML = html;
        out.scrollIntoView({behavior:'smooth', block:'start'});
      }catch(err){
        out.innerHTML = '<div class="card"><h3>Error</h3><div class="pre">'+esc(err?.message||err)+'</div></div>';
      }finally{
        setLoading(false);
      }
    }

    async function resetForm(){
      form.reset();
      labelInput.value = ""; tdsInput.value = "";
      labelMeta.textContent = 'No file chosen.'; tdsMeta.textContent = 'No file chosen.';
      labelPreview.innerHTML = ''; out.innerHTML = '';
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      bindDrop(labelDrop, labelInput, labelMeta, labelPreview);
      bindDrop(tdsDrop, tdsInput, tdsMeta, null);
      btn.addEventListener('click', handleGenerate);
      resetBtn.addEventListener('click', resetForm);
    });
  </script>
</body>
</html>
