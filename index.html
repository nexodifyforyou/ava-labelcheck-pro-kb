<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><!-- APP_NAME -->LabelCheck<!-- /APP_NAME --> — Client Intake</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #0b1020; color: #e7eefc; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 28px; margin-bottom: 8px; }
    p.muted { color: #a8b3cf; margin-top: 0; }
    form { display: grid; gap: 12px; background: #121833; padding: 16px; border-radius: 16px; border: 1px solid #1e2a5a; }
    label { font-weight: 600; font-size: 14px; }
    input, textarea, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #2a3975; background: #0f1530; color: #e7eefc; }
    input[type="file"] { padding: 8px; }
    button { padding: 12px 16px; border: 0; border-radius: 12px; background: #4f7dff; color: white; font-weight: 700; cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .result { margin-top: 16px; background: #0f1530; border: 1px solid #2a3975; padding: 16px; border-radius: 16px; white-space: normal; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    .pass { background: #10b981; color: #002; }
    .caution { background: #f59e0b; color: #220; }
    .fail { background: #ef4444; color: #200; }
    small { color:#9aa7c7; }
    .downloads { display:flex; gap:12px; margin-top:8px; }
    .sectionTitle { margin-top: 14px; font-weight: 700; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1><!-- APP_NAME -->LabelCheck<!-- /APP_NAME --> — Client Intake</h1>
    <p class="muted">Upload a label (image or PDF), optional TDS, and any extra rules. We’ll analyze EU 1169/2011, optionally run Halal pre-audit, and email you a stamped PDF.</p>

    <form id="f" onsubmit="return false">
      <div class="row">
        <div>
          <label>Product name</label>
          <input name="product_name" placeholder="Pasta di Ceci" required />
        </div>
        <div>
          <label>Company name</label>
          <input name="company_name" placeholder="ACME Foods S.r.l." required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Company email (report will be sent here)</label>
          <input name="company_email" type="email" placeholder="qa@acmefoods.it" required />
        </div>
        <div>
          <label>Country of sale</label>
          <input name="country_of_sale" placeholder="Italy" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Languages on label (ISO codes, comma separated)</label>
          <input name="languages_provided" placeholder="it,en" />
        </div>
        <div>
          <label>Shipping scope</label>
          <select name="shipping_scope">
            <option value="local">Local / Domestic</option>
            <option value="eu">EU Single Market</option>
            <option value="global">Global</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Label file (JPG/PNG or PDF)</label>
          <input name="label_file" type="file" accept="image/*,.pdf" required />
          <small>Front-on, readable images work best. PDF is parsed for text only.</small>
        </div>
        <div>
          <label>Optional TDS file (.pdf, .docx, .md, .txt)</label>
          <input name="tds_file" type="file" accept=".pdf,.docx,.md,.txt" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Extra rules / buyer requirements (optional)</label>
          <textarea name="reference_docs_text" rows="4" placeholder="Paste internal spec, buyer rules, claims substantiation..."></textarea>
        </div>
        <div>
          <label><input type="checkbox" name="halal_audit" /> Enable Halal pre-audit</label><br/>
          <small>Adds a Halal section (forbidden ingredients, carriers, logo/issuer, segregation).</small>
        </div>
      </div>

      <button id="generateBtn" type="button">Generate Preflight</button>
    </form>

    <div id="out" class="result" style="display:none"></div>
  </div>

  <script>
    const out = document.getElementById('out');
    const btn = document.getElementById('generateBtn');
    const form = document.getElementById('f');

    async function fileToDataUrlImage(file) {
      const fr = new FileReader();
      const dataUrl = await new Promise((resolve, reject) => {
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });

      const img = await new Promise((resolve, reject) => {
        const i = new Image();
        i.onload = () => resolve(i);
        i.onerror = reject;
        i.src = dataUrl;
      });

      const maxDim = 1600;
      let { width, height } = img;
      if (width > maxDim || height > maxDim) {
        const scale = Math.min(maxDim / width, maxDim / height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }
      const canvas = document.createElement('canvas');
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result); // data:*/*;base64,....
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    async function handleGenerate() {
      btn.disabled = true;
      out.style.display = 'block';
      out.textContent = 'Processing…';

      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.languages_provided = (payload.languages_provided || '')
        .split(',').map(s => s.trim()).filter(Boolean);
      payload.halal_audit = !!fd.get('halal_audit');

      const labelFile = fd.get('label_file');
      if (!labelFile || !labelFile.size) { alert('Please choose a label file.'); btn.disabled = false; return; }
      if (labelFile.type === 'application/pdf' || /\.pdf$/i.test(labelFile.name)) {
        payload.label_pdf_file = { name: labelFile.name, base64: await fileToBase64(labelFile) };
      } else {
        payload.label_image_data_url = await fileToDataUrlImage(labelFile);
      }

      const tds = fd.get('tds_file');
      if (tds && tds.size) {
        payload.tds_file = { name: tds.name, base64: await fileToBase64(tds) };
      }

      try {
        const res = await fetch('/api/labelcheck', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let data;
        try { data = JSON.parse(raw); }
        catch { out.textContent = 'Server error:\n' + raw; btn.disabled = false; return; }

        if (data.error) throw new Error(data.error);

        // Render summary + score
        const esc = s => (s==null ? "" : String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));
        const status = data.report?.overall_status || 'caution';
        const badge = `<span class="badge ${status}">${status.toUpperCase()}</span>`;
        const score = data.score ?? '-';
        const prod = data.report?.product || {};
        let html = `${badge} <b>Score:</b> ${score}/100<br/>
          <div class="sectionTitle">Product</div>
          <div style="margin-top:6px; padding:10px; border:1px solid #2a3975; border-radius:10px; background:#0b122c;">
            <div><b>Name:</b> ${esc(prod.name) || "-"}</div>
            <div><b>Country of sale:</b> ${esc(prod.country_of_sale) || "-"}</div>
            <div><b>Languages:</b> ${(prod.languages_provided || []).join(", ") || "-"}</div>
            <div><b>Halal pre-audit:</b> ${data.halal_audit ? "ON" : "OFF"}</div>
          </div>
          <div class="sectionTitle">EU 1169/2011 Checks</div>`;

        for (const c of (data.report?.checks || [])) {
          html += `• [${(c.status||'').toUpperCase()} | ${c.severity}] ${c.title}<br>`;
          if (c.detail) html += `<span class="pre">- ${esc(c.detail)}</span><br>`;
          if (c.status !== 'ok') {
            if (c.fix) html += `→ <span class="pre">Fix: ${esc(c.fix)}</span><br>`;
            if (Array.isArray(c.sources) && c.sources.length) {
              html += `<span class="pre">Sources: ${esc(c.sources.join("; "))}</span><br>`;
            }
          }
          html += `<br>`;
        }

        if (Array.isArray(data.halal_checks) && data.halal_checks.length) {
          html += `<div class="sectionTitle">Halal Pre-Audit</div>`;
          for (const c of data.halal_checks) {
            html += `• [${(c.status||'').toUpperCase()} | ${c.severity}] ${esc(c.title || "Halal check")}<br>`;
            if (c.detail) html += `<span class="pre">- ${esc(c.detail)}</span><br>`;
            if (c.status !== 'ok') {
              if (c.fix) html += `→ <span class="pre">Fix: ${esc(c.fix)}</span><br>`;
              if (Array.isArray(c.sources) && c.sources.length) {
                html += `<span class="pre">Sources: ${esc(c.sources.join("; "))}</span><br>`;
              }
            }
            html += `<br>`;
          }
        }

        // Downloads
        html += `<div class="downloads">`;
        if (data.pdf_base64) {
          const pdfHref = 'data:application/pdf;base64,' + data.pdf_base64;
          html += `<a download="Preflight_Report.pdf" href="${pdfHref}"><button type="button">Download PDF</button></a>`;
        }
        if (data.fixpack_text) {
          const blob = new Blob([data.fixpack_text], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          html += `<a download="Fix_Pack.txt" href="${url}"><button type="button">Download Fix Pack</button></a>`;
        }
        html += `</div>`;

        out.innerHTML = html;

      } catch (err) {
        out.textContent = 'Error: ' + (err?.message || err);
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById('generateBtn').addEventListener('click', handleGenerate);
  </script>
</body>
</html>
