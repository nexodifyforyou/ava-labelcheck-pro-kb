<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- ***** CHANGE HERE: App name & subtitle shown in the UI ***** -->
  <title><!-LabelCheck<!-- /APP_NAME --> — Client Intake</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #0b1020; color: #e7eefc; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 28px; margin-bottom: 8px; }
    p.muted { color: #a8b3cf; margin-top: 0; }
    form { display: grid; gap: 12px; background: #121833; padding: 16px; border-radius: 16px; border: 1px solid #1e2a5a; }
    label { font-weight: 600; font-size: 14px; }
    input, textarea, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #2a3975; background: #0f1530; color: #e7eefc; }
    input[type="file"] { padding: 8px; }
    button { padding: 12px 16px; border: 0; border-radius: 12px; background: #4f7dff; color: white; font-weight: 700; cursor: pointer; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .result { margin-top: 16px; background: #0f1530; border: 1px solid #2a3975; padding: 16px; border-radius: 16px; white-space: normal; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .pre { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; }
    .pass { background: #10b981; color: #002; }
    .caution { background: #f59e0b; color: #220; }
    .fail { background: #ef4444; color: #200; }
    small { color:#9aa7c7; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ***** CHANGE HERE: page headline & subtitle ***** -->
    <h1><!-- APP_NAME -->LabelCheck<!-- /APP_NAME --> — Client Intake</h1>
    <p class="muted">Upload a JPG/PNG of your label. We’ll OCR it, apply EU 1169/2011 + your House Rules, generate a stamped PDF, and (optionally) email it.</p>

    <!-- prevent default submit no matter what -->
    <form id="f" onsubmit="return false">
      <div class="row">
        <div>
          <label>Product name</label>
          <input name="product_name" placeholder="Pasta di Ceci" required />
        </div>
        <div>
          <label>Company name</label>
          <input name="company_name" placeholder="ACME Foods S.r.l." required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Company email (report will be sent here)</label>
          <input name="company_email" type="email" placeholder="qa@acmefoods.it" required />
        </div>
        <div>
          <label>Country of sale</label>
          <input name="country_of_sale" placeholder="Italy" required />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Languages on label (ISO codes, comma separated)</label>
          <input name="languages_provided" placeholder="it,en" />
        </div>
        <div>
          <label>Shipping scope</label>
          <select name="shipping_scope">
            <option value="local">Local / Domestic</option>
            <option value="eu">EU Single Market</option>
            <option value="global">Global</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Product category</label>
          <select name="product_category">
            <option value="general">General</option>
            <option value="beverage">Beverage</option>
            <option value="chocolate">Chocolate & Cocoa</option>
            <option value="meat">Meat</option>
            <option value="fish">Fish</option>
            <option value="supplement">Food Supplement</option>
            <option value="baby">Infant / Baby Food</option>
            <option value="honey">Honey</option>
            <option value="olive_oil">Olive Oil</option>
          </select>
        </div>
        <div>
          <label>Label image (JPG/PNG)</label>
          <input name="label_image" type="file" accept="image/*" required />
          <small>Large images may take longer. Clear, straight photos work best.</small>
        </div>
      </div>

      <label>Optional: extra rules or buyer requirements (used only for this report)</label>
      <textarea name="reference_docs_text" rows="4" placeholder="Paste internal spec, claims substantiation, or buyer’s requirements..."></textarea>

      <!-- DO NOT SUBMIT THE FORM; we handle click in JS -->
      <button id="generateBtn" type="button">Generate Compliance Report</button>
    </form>

    <div id="out" class="result" style="display:none"></div>
  </div>

  <script>
    const form = document.getElementById('f');
    const out = document.getElementById('out');
    const btn = document.getElementById('generateBtn');

    // Resize to <=1600px, JPEG quality 0.85 to keep payload small
    async function fileToDataUrl(file) {
      if (!file) return null;
      const img = await new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const i = new Image();
          i.onload = () => resolve(i);
          i.onerror = reject;
          i.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
      const maxDim = 1600;
      let { width, height } = img;
      if (width > maxDim || height > maxDim) {
        const scale = Math.min(maxDim / width, maxDim / height);
        width = Math.round(width * scale);
        height = Math.round(height * scale);
      }
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      return canvas.toDataURL('image/jpeg', 0.85);
    }

    async function handleGenerate() {
      // build payload from the form
      const fd = new FormData(form);
      const payload = Object.fromEntries(fd.entries());
      payload.languages_provided = (payload.languages_provided || '')
        .split(',').map(s => s.trim()).filter(Boolean);

      const imgFile = fd.get('label_image');
      if (!imgFile || !imgFile.size) {
        alert('Please choose a label image (JPG/PNG).');
        return;
      }

      payload.label_image_data_url = await fileToDataUrl(imgFile);

      out.style.display = 'block';
      out.textContent = 'Processing…';
      btn.disabled = true;

      try {
        const res = await fetch('/api/labelcheck', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await res.text(); // support non-JSON errors
        let data;
        try { data = JSON.parse(raw); }
        catch { out.textContent = 'Server error:\n' + raw; btn.disabled = false; return; }

        if (data.error) throw new Error(data.error);

        const status = data.report?.overall_status || 'caution';
        const badge = `<span class="badge ${status}">${status.toUpperCase()}</span>`;
        const head = `${badge} ${data.report?.summary || ''}`;

        // Pretty product view (no raw JSON)
        const prod = data.report?.product || {};
        const esc = (s) => (s==null ? "" : String(s)
          .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"));
        const prodHtml = `
          <div style="margin-top:8px">
            <strong>Product</strong>
            <div style="margin-top:6px; padding:10px; border:1px solid #2a3975; border-radius:10px; background:#0b122c;">
              <div><b>Name:</b> ${esc(prod.name) || "-"}</div>
              <div><b>Country of sale:</b> ${esc(prod.country_of_sale) || "-"}</div>
              <div><b>Languages:</b> ${(prod.languages_provided || []).join(", ") || "-"}</div>
            </div>
          </div>
        `;

        let html = `${head}${prodHtml}<br><strong>Checks</strong><br>`;
        for (const c of (data.report?.checks || [])) {
          html += `• [${(c.status||'').toUpperCase()} | ${c.severity}] ${c.title}<br>`;
          if (c.detail) html += `<span class="pre">- ${c.detail}</span><br>`;
          if (c.fix)    html += `→ <span class="pre">Fix: ${c.fix}</span><br>`;
          html += `<br>`;
        }

        out.innerHTML = html;

        if (data.pdf_base64) {
          const a = document.createElement('a');
          a.href = 'data:application/pdf;base64,' + data.pdf_base64;
          a.download = 'Compliance_Report.pdf';
          a.textContent = 'Download PDF Report';
          a.style.display = 'inline-block';
          a.style.marginTop = '6px';
          out.appendChild(a);
        }

      } catch (err) {
        out.textContent = 'Error: ' + (err?.message || err);
      } finally {
        btn.disabled = false;
      }
    }

    // Click handler instead of submit (prevents page refresh even if JS attaches late)
    btn.addEventListener('click', handleGenerate);
  </script>
</body>
</html>
