<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Nexodify’s Label Compliance Preflight</title>
<style>
  :root{
    --bg:#0b1020;--ink:#eaf0ff;--muted:#a6b4da;--line:#1f2a5b;--card:#11183a;
    --chip:#1c2755;--brand:#5b84ff;--ok:#18c37d;--warn:#ffb020;--bad:#ff5a5a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1040px;margin:26px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .dot{width:18px;height:18px;border-radius:6px;background:var(--brand);box-shadow:0 0 24px rgba(91,132,255,.45)}
  h1{margin:0;font-size:24px}
  .tagline{color:var(--muted);margin-top:2px}
  .subtag{color:#7e8dbd;font-size:12px;margin-top:2px}

  .grid{display:grid;gap:14px}
  @media (min-width:980px){.grid.two{grid-template-columns:1fr 1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .card h3{margin:0 0 10px 0;font-size:14px;letter-spacing:.2px;color:#d6defb}

  label{font-weight:700;font-size:12px;margin-bottom:6px;display:block}
  input,select,textarea{width:100%;background:#0f1530;border:1px solid #2b3a78;border-radius:10px;color:var(--ink);padding:10px}
  textarea{resize:vertical}
  .row{display:grid;gap:10px}
  .two{grid-template-columns:1fr 1fr}

  .drop{border:1px dashed #3950a3;background:#0e1430;border-radius:12px;padding:14px;text-align:center;color:#c7d3ff}
  .help{color:var(--muted);font-size:12px;margin-top:6px}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
  .btn{background:var(--brand);border:0;color:#fff;font-weight:800;border-radius:10px;padding:12px 16px;cursor:pointer}
  .btn.secondary{background:#2b3a78}
  .btn.ghost{background:transparent;border:1px solid #2b3a78}
  .btn[disabled]{opacity:.6;pointer-events:none}

  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .chip{padding:4px 10px;border-radius:999px;background:var(--chip);border:1px solid #2b3a78;color:#cfd8ff;font-size:12px}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900;margin-right:6px}
  .pass{background:var(--ok);color:#081e13}
  .caution{background:var(--warn);color:#231600}
  .fail{background:var(--bad);color:#200707}

  .section{margin-top:14px}
  .pre{white-space:pre-wrap;background:#0e1532;border:1px solid #2b3a78;border-radius:10px;padding:10px;color:#d6defb}
  .checks{padding-top:4px}
  .check{background:#0e1532;border:1px solid #2b3a78;border-left:4px solid #2b3a78;border-radius:10px;padding:10px;margin:8px 0}
  .check.ok{border-left-color:var(--ok)}
  .check.med{border-left-color:#ffb020}
  .check.bad{border-left-color:#ff5a5a}
  .check .ttl{font-weight:800}
  .hint{color:var(--muted);font-size:12px}
  .downloads{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}

  /* Admin UI */
  .admin-button{
    position:fixed;left:12px;top:12px;z-index:20;background:#0e1532;border:1px solid #2b3a78;color:#cfd8ff;
    padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:800
  }
  .admin-panel{
    position:fixed;left:12px;top:56px;width:280px;background:#0f1530;border:1px solid #2b3a78;border-radius:12px;
    padding:12px;z-index:20;display:none
  }
  .admin-row{display:grid;gap:8px;margin-top:8px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2b3a78;color:#cfd8ff}
  .pill.ok{background:#093;border-color:#0a7}
  .pill.err{background:#5a0;border-color:#b50}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal > .box{background:#0f1530;border:1px solid #2b3a78;border-radius:12px;padding:16px;width:420px}
  .row2{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}

  /* Dataset basket */
  .tabbar{display:flex;gap:8px;margin:8px 0}
  .tab{padding:6px 10px;border-radius:999px;background:#0f1530;border:1px solid #2b3a78;color:#cfd8ff;cursor:pointer}
  .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #2b3a78;padding:6px;font-size:12px;vertical-align:top}
  .tagbtn{padding:2px 8px;border-radius:999px;border:1px solid #2b3a78;background:#0f1530;color:#cfd8ff;cursor:pointer}

  /* Collapsible TDS */
  .collapser{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-top:8px}
  .collapse-content{display:none;margin-top:10px}
  .switch{display:inline-flex;align-items:center;gap:8px}
</style>
</head>
<body>
  <!-- Admin button & panel -->
  <button class="admin-button" id="adminBtn">Admin</button>
  <div class="admin-panel" id="adminPanel">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:900">Admin Panel</div>
      <span id="adminStatus" class="pill">—</span>
    </div>
    <div class="admin-row">
      <label>Date (UTC, YYYY-MM-DD)</label>
      <input id="adminDay" placeholder="YYYY-MM-DD">
    </div>
    <div class="admin-row">
      <button class="btn ghost" id="btnRuns">Download Runs CSV</button>
      <button class="btn ghost" id="btnChecks">Download Checks CSV</button>
      <button class="btn ghost" id="btnCorrections">Download Corrections CSV</button>
    </div>
  </div>

  <!-- Admin passkey modal -->
  <div class="modal" id="keyModal">
    <div class="box">
      <div style="font-weight:900;margin-bottom:8px">Enter Admin Passkey</div>
      <input id="adminKeyInput" placeholder="••••••••" autocomplete="off">
      <div id="keyMsg" class="help"></div>
      <div class="row2">
        <button class="btn secondary" id="cancelKey">Cancel</button>
        <button class="btn" id="saveKey">Continue</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="dot"></div>
      <div>
        <h1>Nexodify’s Label Compliance Preflight</h1>
        <div class="tagline">Cited. Actionable. Production-ready.</div>
        <div class="subtag">EU 1169/2011 preflight • optional Halal pre-audit • PDF report</div>
      </div>
    </header>

    <!-- Product / Company -->
    <div class="grid two">
      <div class="card">
        <h3>Product</h3>
        <div class="row two">
          <div>
            <label>Product name</label>
            <input id="product_name" placeholder="Pasta di Ceci">
          </div>
          <div>
            <label>Category</label>
            <select id="product_category">
              <option>General</option><option>Confectionery</option><option>Beverage</option>
              <option>Dairy</option><option>Meat / Fish</option>
            </select>
          </div>
        </div>
        <div class="row two" style="margin-top:8px">
          <div>
            <label>Country of sale</label>
            <input id="country_of_sale" placeholder="Italy">
          </div>
          <div>
            <label>Languages on label (ISO, comma)</label>
            <input id="languages_provided" placeholder="it,en">
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Shipping scope</label>
          <select id="shipping_scope">
            <option>Local / Domestic</option><option>EU Single Market</option><option>Global</option>
          </select>
        </div>
      </div>

      <div class="card">
        <h3>Company</h3>
        <div>
          <label>Company name</label>
          <input id="company_name" placeholder="ACME Foods S.r.l.">
        </div>
        <div style="margin-top:8px">
          <label>Company email (report will be sent here)</label>
          <input id="company_email" placeholder="qa@acme.com; qa2@acme.com">
          <div class="help">Multiple emails allowed (comma or semicolon).</div>
        </div>
      </div>
    </div>

    <!-- Files -->
    <div class="grid two" style="margin-top:14px">
      <div class="card">
        <h3>Label file (JPG/PNG or PDF)</h3>
        <div id="labelDrop" class="drop">Drag & drop or click to choose</div>
        <input id="label_file" type="file" accept="image/*,application/pdf" style="display:none">
        <div id="labelMeta" class="help">No file chosen.</div>
        <div class="help">Front-on, readable images work best. PDF text is parsed for text only.</div>
      </div>

      <div class="card">
        <h3>Optional TDS (.pdf, .docx, .md, .txt)</h3>
        <div id="tdsDrop" class="drop">Drag & drop or click to attach</div>
        <input id="tds_file" type="file" accept="application/pdf,.doc,.docx,.md,.txt" style="display:none">
        <div id="tdsMeta" class="help">No file chosen.</div>
      </div>
    </div>

    <!-- Structured TDS (toggle + collapsible) -->
    <div class="card" style="margin-top:14px">
      <div class="collapser">
        <h3 style="margin:0">Structured TDS (key particulars)</h3>
        <label class="switch">
          <input type="checkbox" id="tdsToggle">
          <span>Manual TDS entry?</span>
        </label>
      </div>
      <div class="help">When enabled, these fields are bundled as <b>tds_struct</b>. When disabled, the engine relies on your uploaded TDS file and/or the free-text “Extra rules”.</div>

      <div id="tdsBlock" class="collapse-content">
        <div class="grid two" style="margin-top:8px">
          <div>
            <label>Composition / Ingredients (descending)</label>
            <textarea id="tds_ing" rows="3" placeholder="Chickpea flour (60%), water, salt…"></textarea>
          </div>
          <div>
            <label>Annex II Allergens (bolded in label)</label>
            <textarea id="tds_allergens" rows="3" placeholder="Gluten; Soy; Milk; Tree nuts…"></textarea>
          </div>
          <div>
            <label>QUID drivers (% near name or in list)</label>
            <textarea id="tds_quid" rows="2" placeholder="Chickpeas 60%; Cocoa 35%; Fruit 12%…"></textarea>
          </div>
          <div>
            <label>Nutrition (per 100 g/ml)</label>
            <textarea id="tds_nutri" rows="2" placeholder="Energy 1500 kJ / 360 kcal; Fat 2.0 g…"></textarea>
          </div>
          <div>
            <label>Net quantity</label>
            <textarea id="tds_netqty" rows="2" placeholder="500 g; 1 L; ℮ symbol if used"></textarea>
          </div>
          <div>
            <label>Storage / Use conditions</label>
            <textarea id="tds_storage" rows="2" placeholder="Keep in a cool, dry place. Refrigerate after opening…"></textarea>
          </div>
          <div>
            <label>FBO name & EU address</label>
            <textarea id="tds_fbo" rows="2" placeholder="ACME Foods S.r.l., Via Roma 10, 20100 Milano, IT"></textarea>
          </div>
          <div>
            <label>Date marking</label>
            <textarea id="tds_date" rows="2" placeholder="Best before end: MM/YYYY; Use by: DD/MM/YYYY"></textarea>
          </div>
          <div>
            <label>Claims (nutrition/health/marketing)</label>
            <textarea id="tds_claims" rows="2" placeholder="High in protein; No added sugar; Source of fiber…"></textarea>
          </div>
          <div>
            <label>Country of origin / Primary ingredient origin</label>
            <textarea id="tds_origin" rows="2" placeholder="Origin: Italy; Primary ingredient: EU…"></textarea>
          </div>
          <div>
            <label>Additives & processing aids</label>
            <textarea id="tds_additives" rows="2" placeholder="E471 (plant), E322 (sunflower lecithin), enzymes…"></textarea>
          </div>
          <div>
            <label>Certifications / Logos (e.g., Halal, Organic)</label>
            <textarea id="tds_certs" rows="2" placeholder="Halal by X Certifier; EU Organic; Gluten-Free…"></textarea>
          </div>
          <div style="grid-column:1/-1">
            <label>Notes / Buyer rules / Evidence</label>
            <textarea id="tds_notes" rows="3" placeholder="Paste internal spec, buyer rules, emails, supplier letters, SDS, etc."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Extra free-text rules -->
    <div class="card" style="margin-top:14px">
      <h3>Extra rules / buyer requirements (optional)</h3>
      <textarea id="reference_docs_text" rows="5" placeholder="Paste internal spec, buyer rules, claims substantiation..."></textarea>
      <div class="help">If omitted, the engine uses EU baseline and our internal database.</div>
    </div>

    <!-- Options -->
    <div class="card" style="margin-top:14px">
      <h3>Options & Consent</h3>
      <div class="row" style="grid-template-columns:auto 1fr;align-items:center;margin-top:10px">
        <input id="consent_chk" type="checkbox" style="width:18px;height:18px;margin:0 8px 0 4px">
        <div>
          <div style="font-weight:700">I consent to processing & secure storage</div>
          <div class="help">
            I agree that Nexodify may process and securely store my files and metadata for quality improvement and auditability.
            Data controller: Nexodify. Retention: kept indefinitely (delete on request). No sale to third parties.
          </div>
        </div>
      </div>

      <div class="row" style="grid-template-columns:auto 1fr;align-items:center">
        <input id="halal_audit" type="checkbox" style="width:18px;height:18px;margin:0 8px 0 4px">
        <div>
          <div style="font-weight:700">Enable Halal pre-audit</div>
          <div class="help">Adds checks for forbidden ingredients, carriers/solvents, logo/issuer, segregation.</div>
        </div>
      </div>

      <div class="toolbar">
        <button class="btn secondary" id="resetBtn" type="button">Reset</button>
        <button class="btn" id="goBtn">Generate Preflight</button>
      </div>
    </div>

    <!-- Results -->
    <div id="results" style="margin-top:16px;display:none">
      <div class="card" id="summaryCard"></div>
      <div id="checksWrap"></div>
      <div class="card downloads" id="downloadsCard" style="display:none"></div>
    </div>

    <!-- Dataset Basket (ADMIN ONLY) -->
    <div class="card" id="basketCard" style="margin-top:16px; display:none">
      <h3>Dataset Basket (admin only)</h3>
      <div class="tabbar">
        <button class="tab active" data-tab="all">All</button>
        <button class="tab" data-tab="train">Train</button>
        <button class="tab" data-tab="test">Test</button>
        <button class="tab" data-tab="val">Validation</button>
      </div>
      <div id="basketTableWrap" class="help">No items in this tab.</div>
      <div class="toolbar">
        <button class="btn secondary" id="clearBasketBtn" type="button">Clear Dataset Basket</button>
        <button class="btn secondary" id="resetFormBtn" type="button">Reset Form</button>
        <button class="btn" id="exportTabBtn" type="button">Export CSV</button>
        <button class="btn" id="exportAllBtn" type="button">Export CSV (All)</button>
      </div>
    </div>
  </div>

<script>
/* ------------------ Config ------------------ */
const API_BASE = "https://api.nexodify.com";

/* ------------------ Helpers ------------------ */
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s??"").replace(/[&<>]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;" }[c]));
const isArray = (v)=>Array.isArray(v);
const fmtKB = (n)=>Math.round((n||0)/1024);
const today = ()=>new Date().toISOString().slice(0,10);
function overallClass(s){ s=(s||"caution").toLowerCase(); return s==="pass"?"pass":s==="fail"?"fail":"caution"; }
function toDataURL(file){ return new Promise((resolve,reject)=>{const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(file);});}

/* ------------------ Admin: key storage & ping ------------------ */
/* Force admin logout on every refresh */
sessionStorage.removeItem("admin_ok");
sessionStorage.removeItem("admin_key");

const adminBtn = $("adminBtn");
const adminPanel = $("adminPanel");
const adminStatus = $("adminStatus");
const keyModal = $("keyModal");
const adminKeyInput = $("adminKeyInput");
const keyMsg = $("keyMsg");
const saveKey = $("saveKey");
const cancelKey = $("cancelKey");
const adminDay = $("adminDay");
const basketCard = $("basketCard");
adminDay.value = today();

function getAdminKey(){ return sessionStorage.getItem("admin_key") || ""; }
function setAdminKey(k){ sessionStorage.setItem("admin_key", k); }
function adminAuthenticated(){ return !!sessionStorage.getItem("admin_ok"); }
function setAdminAuth(ok){
  if(ok){ sessionStorage.setItem("admin_ok","1"); basketCard.style.display="block"; }
  else { sessionStorage.removeItem("admin_ok"); basketCard.style.display="none"; }
}
async function pingAdmin(){
  const key = getAdminKey();
  if(!key){ adminStatus.textContent="no key"; adminStatus.className="pill err"; setAdminAuth(false); return false; }
  try{
    const r = await fetch(`${API_BASE}/admin/ping`, { headers: { "x-admin-key": key }});
    if(r.ok){ adminStatus.textContent="OK"; adminStatus.className="pill ok"; setAdminAuth(true); return true; }
    adminStatus.textContent="Forbidden"; adminStatus.className="pill err"; setAdminAuth(false); return false;
  }catch(e){ adminStatus.textContent="Error"; adminStatus.className="pill err"; setAdminAuth(false); return false; }
}

adminBtn.addEventListener("click", async ()=>{
  if(getAdminKey()){
    adminPanel.style.display = adminPanel.style.display==="none"?"block":"none";
    await pingAdmin();
  } else {
    keyModal.style.display="flex";
    adminKeyInput.value="";
    keyMsg.textContent="";
  }
});
saveKey.addEventListener("click", async ()=>{
  const k = adminKeyInput.value.trim();
  if(!k){ keyMsg.textContent="Enter a passkey."; return; }
  setAdminKey(k);
  keyModal.style.display="none";
  adminPanel.style.display="block";
  await pingAdmin();
});
cancelKey.addEventListener("click", ()=> keyModal.style.display="none");

/* Admin export helpers */
async function downloadCsv(type){
  const day = (adminDay.value||today()).trim();
  const key = getAdminKey();
  if(!key){ adminPanel.style.display="none"; keyModal.style.display="flex"; return; }
  try{
    const res = await fetch(`${API_BASE}/admin/export?type=${encodeURIComponent(type)}&day=${encodeURIComponent(day)}`, {
      headers: { "x-admin-key": key }
    });
    if(!res.ok){
      const txt = await res.text();
      alert(`Export failed: ${res.status} ${res.statusText}\n${txt}`);
      await pingAdmin();
      return;
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `${type}_${day}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }catch(e){ alert("Network error: "+e.message); }
}
$("btnRuns").onclick = ()=>downloadCsv("runs");
$("btnChecks").onclick = ()=>downloadCsv("checks");
$("btnCorrections").onclick = ()=>downloadCsv("corrections");

/* ------------------ Dropzones ------------------ */
const productName = $("product_name");
const productCategory = $("product_category");
const companyName = $("company_name");
const companyEmail = $("company_email");
const countrySale = $("country_of_sale");
const languagesProvided = $("languages_provided");
const shippingScope = $("shipping_scope");
const labelInput = $("label_file");
const tdsInput = $("tds_file");
const labelDrop = $("labelDrop");
const tdsDrop = $("tdsDrop");
const labelMeta = $("labelMeta");
const tdsMeta = $("tdsMeta");
const extraRules = $("reference_docs_text");
const halalToggle = $("halal_audit");
const consentChk = $("consent_chk");
const goBtn = $("goBtn");
const resetBtn = $("resetBtn");
const results = $("results");
const summaryCard = $("summaryCard");
const checksWrap = $("checksWrap");
const downloadsCard = $("downloadsCard");

function setLoading(b){ goBtn.disabled=b; goBtn.textContent=b?"Generating…":"Generate Preflight"; }
function wireDrop(zone,input,meta){
  const setMeta = (f)=>meta.textContent = f ? `${f.name} (${Math.round(f.size/1024)} KB)` : "No file chosen.";
  zone.addEventListener("click",()=>input.click());
  zone.addEventListener("dragover",e=>{e.preventDefault(); zone.style.borderColor="#6f90ff";});
  zone.addEventListener("dragleave",()=>zone.style.borderColor="#3950a3");
  zone.addEventListener("drop",e=>{
    e.preventDefault(); zone.style.borderColor="#3950a3";
    const f=e.dataTransfer.files?.[0]; if(!f) return;
    input.files = e.dataTransfer.files; setMeta(f);
  });
  input.addEventListener("change",()=>setMeta(input.files[0]));
}
wireDrop(labelDrop,labelInput,labelMeta);
wireDrop(tdsDrop,tdsInput,tdsMeta);

/* ------------------ Collapsible structured TDS ------------------ */
const tdsToggle = $("tdsToggle");
const tdsBlock = $("tdsBlock");
tdsToggle.addEventListener("change",()=>{
  tdsBlock.style.display = tdsToggle.checked ? "block" : "none";
});
tdsBlock.style.display = "none"; // default collapsed

/* ------------------ Render helpers ------------------ */
function renderCheck(c, idx){
  const lane = c.status==="ok" ? "ok" : (c.severity==="high" ? "bad" : "med");
  const corrUi = (c.status==="ok" || !adminAuthenticated()) ? "" : `
    <div class="hint" style="margin-top:6px">
      <div><b>Proposed fix:</b> ${esc(c.fix||'')}</div>
      <div style="display:grid;gap:6px;margin-top:6px">
        <textarea data-idx="${idx}" class="corr-text" rows="2" placeholder="Your corrected text / label phrasing…"></textarea>
        <input data-idx="${idx}" class="corr-rationale" placeholder="Rationale / reference (optional)">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="tagbtn" data-idx="${idx}" data-tag="train">Tag Train</button>
          <button class="tagbtn" data-idx="${idx}" data-tag="test">Tag Test</button>
          <button class="tagbtn" data-idx="${idx}" data-tag="val">Tag Validation</button>
          <label style="display:flex;gap:6px;align-items:center">
            <input type="checkbox" data-idx="${idx}" class="corr-mand" /> Mandatory?
          </label>
          <button class="btn secondary" data-idx="${idx}" data-action="add-corr">Add to Basket</button>
        </div>
      </div>
    </div>`;
  return `<div class="card check ${lane}">
    <div class="ttl">${esc(c.title||"-")} <span class="chip" style="margin-left:6px">${esc((c.status||"").toUpperCase())}${c.severity?` · ${esc(c.severity)}`:""}</span></div>
    ${c.detail ? `<div>${esc(c.detail)}</div>` : ""}
    ${c.status!=="ok" && c.fix ? `<div>→ <i>${esc(c.fix)}</i></div>` : ""}
    ${isArray(c.sources)&&c.sources.length ? `<div class="hint">Sources: ${c.sources.map(esc).join("; ")}</div>` : ""}
    ${corrUi}
  </div>`;
}
function renderChecksBlock(title, arr){
  if(!isArray(arr)||!arr.length) return "";
  return `<div class="section"><div class="card"><h3>${esc(title)}</h3><div class="checks">${arr.map((c,i)=>renderCheck(c,i)).join("")}</div></div></div>`;
}

/* ------------------ Basket (admin only) ------------------ */
const basket = { all:[], train:[], test:[], val:[] };
let activeTab = "all";
const basketTableWrap = $("basketTableWrap");
const tabs = Array.from(document.querySelectorAll(".tab"));

function basketRowToCsv(r){
  const escCsv = (v)=> {
    if (v===null||v===undefined) return "";
    const s=String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  return [
    r.ts_iso, r.product_name, r.check_title, r.prev_status, r.prev_severity, r.action,
    r.new_text, r.rationale, r.mandatory, (r.sources||[]).join('|'),
    r.overall_score ?? "", r.halal ?? ""
  ].map(escCsv).join(",");
}
function downloadCsvFile(filename, rows, header){
  const csv = [header, ...rows.map(basketRowToCsv)].join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function renderBasket(){
  const arr = basket[activeTab] || [];
  if(!arr.length){ basketTableWrap.className="help"; basketTableWrap.innerHTML="No items in this tab."; return; }
  basketTableWrap.className="";
  const head = `
    <table><thead><tr>
      <th>ts_iso</th><th>product_name</th><th>check_title</th><th>prev_status</th><th>prev_severity</th>
      <th>action</th><th>new_text</th><th>rationale</th><th>mandatory</th><th>sources</th><th>overall_score</th><th>halal</th>
    </tr></thead><tbody>`;
  const rows = arr.map(r=>`<tr>
    <td>${esc(r.ts_iso)}</td><td>${esc(r.product_name)}</td><td>${esc(r.check_title)}</td>
    <td>${esc(r.prev_status)}</td><td>${esc(r.prev_severity)}</td><td>${esc(r.action)}</td>
    <td>${esc(r.new_text)}</td><td>${esc(r.rationale)}</td><td>${r.mandatory?'yes':'no'}</td>
    <td>${esc((r.sources||[]).join('|'))}</td><td>${esc(r.overall_score??'')}</td><td>${esc(r.halal??'')}</td>
  </tr>`).join("");
  basketTableWrap.innerHTML = head + rows + "</tbody></table>";
}
tabs.forEach(btn=>{
  btn.addEventListener("click",()=>{
    tabs.forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    activeTab = btn.dataset.tab;
    renderBasket();
  });
});
$("clearBasketBtn").onclick = ()=>{
  if(!adminAuthenticated()) return;
  basket.all=[]; basket.train=[]; basket.test=[]; basket.val=[]; renderBasket();
};
$("exportTabBtn").onclick = ()=>{
  if(!adminAuthenticated()) return;
  const arr = basket[activeTab]||[];
  if(!arr.length) { alert("No rows to export in this tab."); return; }
  downloadCsvFile(`basket_${activeTab}_${today()}.csv`, arr,
    "ts_iso,product_name,check_title,prev_status,prev_severity,action,new_text,rationale,mandatory,sources,overall_score,halal");
};
$("exportAllBtn").onclick = ()=>{
  if(!adminAuthenticated()) return;
  const all = [...basket.all, ...basket.train, ...basket.test, ...basket.val];
  if(!all.length){ alert("No rows to export."); return; }
  downloadCsvFile(`basket_all_${today()}.csv`, all,
    "ts_iso,product_name,check_title,prev_status,prev_severity,action,new_text,rationale,mandatory,sources,overall_score,halal");
};
$("resetFormBtn").onclick = ()=>resetAll();

/* capture “Add to Basket” clicks */
document.addEventListener("click",(e)=>{
  const t = e.target;
  if(!(t instanceof HTMLElement)) return;
  if(t.dataset?.action==="add-corr"){
    if(!adminAuthenticated()){ alert("Admin only. Click Admin and enter passkey."); return; }
    const idx = Number(t.dataset.idx||0);
    const txt = document.querySelector(`.corr-text[data-idx="${idx}"]`)?.value?.trim()||"";
    const rat = document.querySelector(`.corr-rationale[data-idx="${idx}"]`)?.value?.trim()||"";
    const man = document.querySelector(`.corr-mand[data-idx="${idx}"]`)?.checked||false;
    // choose last selected tag for this idx; default all
    let tag="all";
    const tagBtns = document.querySelectorAll(`.tagbtn[data-idx="${idx}"]`);
    tagBtns.forEach(b=>{ if(b.classList.contains('last-tagged')) tag = b.dataset.tag; });
    const chk = lastResponseReport?.checks?.[idx] || {};
    const row = {
      ts_iso: new Date().toISOString(),
      product_name: lastResponseReport?.product?.name || (productName.value||""),
      check_title: chk.title || "",
      prev_status: chk.status || "",
      prev_severity: chk.severity || "",
      action: "replace_text",
      new_text: txt,
      rationale: rat,
      mandatory: !!man,
      sources: chk.sources || [],
      overall_score: lastResponseReport?.score ?? lastResponseReport?.overall_score,
      halal: !!(lastHalalOn)
    };
    basket[tag].push(row);
    renderBasket();
    alert("Added to dataset basket.");
  }
  if(t.classList.contains("tagbtn")){
    const idx = t.dataset.idx;
    document.querySelectorAll(`.tagbtn[data-idx="${idx}"]`).forEach(b=>b.classList.remove("last-tagged"));
    t.classList.add("last-tagged");
  }
});

/* ------------------ Form wiring ------------------ */
function resetAll(){
  [productName, companyName, companyEmail, countrySale, languagesProvided].forEach(el=>el.value="");
  productCategory.selectedIndex = 0; shippingScope.selectedIndex=0; halalToggle.checked=false; extraRules.value="";
  ["tds_ing","tds_allergens","tds_quid","tds_nutri","tds_netqty","tds_storage","tds_fbo","tds_date","tds_claims","tds_origin","tds_additives","tds_certs","tds_notes"]
    .forEach(id=>{ const el=$(id); if(el) el.value=""; });
  tdsToggle.checked=false; tdsBlock.style.display="none";
  consentChk.checked = false;
  labelInput.value=""; tdsInput.value=""; labelMeta.textContent="No file chosen."; tdsMeta.textContent="No file chosen.";
  results.style.display="none"; summaryCard.innerHTML=""; checksWrap.innerHTML=""; downloadsCard.style.display="none"; downloadsCard.innerHTML="";
}
resetBtn.addEventListener("click", resetAll);

let lastResponseReport=null, lastHalalOn=false;

goBtn.addEventListener("click", async ()=>{
  try{
    setLoading(true);
    if (!consentChk.checked) {
      setLoading(false);
      alert("Please tick consent to proceed.");
      return;
    }
    results.style.display="block";
    summaryCard.innerHTML = '<div class="pre">Running…</div>';
    checksWrap.innerHTML=""; downloadsCard.style.display="none"; downloadsCard.innerHTML="";

    // Build request payload
    const fields = {
      product_name: productName.value.trim(),
      company_name: companyName.value.trim(),
      company_email: companyEmail.value.trim(), // server handles multi
      country_of_sale: countrySale.value.trim(),
      languages_provided: (languagesProvided.value||"").split(/[,;]\s*|,\s*|\s*,\s*/).map(s=>s.trim()).filter(Boolean),
      shipping_scope: shippingScope.value,
      product_category: productCategory.value,
      reference_docs_text: extraRules.value || "",
      halal_audit: halalToggle.checked
    };
    lastHalalOn = fields.halal_audit;

    // If manual TDS is enabled, append tds_struct
    if (tdsToggle.checked) {
      fields.reference_docs_text =
        buildTdsStructured() + (fields.reference_docs_text ? ("\n\n" + fields.reference_docs_text) : "");
    }

    // Attach files
    if(labelInput.files[0]){
      const lf = labelInput.files[0];
      const b64 = await toDataURL(lf);
      if(lf.type==="application/pdf") fields.label_pdf_file = { name: lf.name, base64: b64 };
      else fields.label_image_data_url = b64;
    }
    if(tdsInput.files[0]){
      const tf = tdsInput.files[0];
      fields.tds_file = { name: tf.name, base64: await toDataURL(tf) };
    }

    // Call API
    const resp = await fetch(`${API_BASE}/api/check-label`, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(fields)
    });
    const data = await resp.json();

    lastResponseReport = data.report || null;

    const overall = (data.report?.overall_status || "caution");
    const badgeCls = overallClass(overall);
    const score = data.score ?? data.report?.score ?? "-";
    const prod = data.report?.product || {};

    // Summary
    summaryCard.innerHTML = `
      <div class="chips">
        <span class="badge ${badgeCls}">${esc(overall.toUpperCase())}</span>
        <span class="chip">Score ${esc(score)}/100</span>
        <span class="chip">Halal: ${data.halal_audit?'ON':'OFF'}</span>
        ${data.email_status ? `<span class="chip">Email: ${esc(data.email_status)}</span>` : ''}
        ${data.pdf_len ? `<span class="chip">PDF: ${esc(data.pdf_len)}</span>` : ''}
      </div>
      <div class="row two" style="margin-top:6px">
        <div><b>Name:</b> ${esc(prod.name)||'-'}</div>
        <div><b>Country:</b> ${esc(prod.country_of_sale)||'-'}</div>
      </div>
      <div style="margin-top:4px"><b>Languages:</b> ${(prod.languages_provided||[]).join(', ')||'-'}</div>
      ${data.report?.summary ? `<div class="pre" style="margin-top:8px">${esc(data.report.summary)}</div>` : ''}
    `;

    // Checks
    let blocks = '';
    blocks += renderChecksBlock("EU 1169/2011 Checks", data.report?.checks);
    if(isArray(data.halal_checks) && data.halal_checks.length){
      blocks += renderChecksBlock("Halal Pre-Audit", data.halal_checks);
    }
    checksWrap.innerHTML = blocks;

    // Downloads
    const pdfReady = !!(data.pdf_base64 && (data.pdf_base64.length>1000));
    downloadsCard.style.display = "flex";
    downloadsCard.innerHTML = `
      <div>
        <div style="font-weight:900">Downloads</div>
        ${pdfReady
          ? `<div class="hint">PDF ready (${fmtKB((data.pdf_base64.length*3)/4)} KB)</div>`
          : `<div class="hint">PDF unavailable${data.pdf_error?' — '+esc(data.pdf_error):''}</div>`}
      </div>
      <div>
        ${pdfReady ? `
          <a download="Preflight_Report.pdf" href="data:application/pdf;base64,${data.pdf_base64}">
            <button class="btn" type="button">Download Report (PDF)</button>
          </a>` : ``}
      </div>
    `;
  }catch(err){
    summaryCard.innerHTML = `<div class="pre">Error: ${esc(err?.message||err)}</div>`;
  }finally{
    setLoading(false);
  }
});

/* Build the structured TDS bundle */
function buildTdsStructured(){
  const get = (id)=>$(id).value?.trim()||"";
  const t = {
    composition: get("tds_ing"),
    allergens: get("tds_allergens"),
    quid: get("tds_quid"),
    nutrition_100: get("tds_nutri"),
    net_quantity: get("tds_netqty"),
    storage_use: get("tds_storage"),
    fbo_eu_address: get("tds_fbo"),
    date_marking: get("tds_date"),
    claims: get("tds_claims"),
    origin: get("tds_origin"),
    additives_aids: get("tds_additives"),
    certifications: get("tds_certs"),
    notes_evidence: get("tds_notes")
  };
  return "TDS_STRUCT:\n" + Object.entries(t).map(([k,v])=>`- ${k}: ${v}`).join("\n");
}
</script>
</body>
</html>
